name: Send Push Notifications

on:
  schedule:
    # Ejecuta todos los d√≠as a las 8:00 AM Colombia (13:00 UTC)
    # Formato: minuto hora d√≠a mes d√≠a-semana (UTC)
    - cron: '0 13 * * *'
  workflow_dispatch: # Permite ejecuci√≥n manual desde GitHub

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Call Push Schedule API
        id: call-api
        run: |
          echo "üïê Current UTC time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "üìû Calling push schedule endpoint..."
          
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "https://fit-tracker-iota.vercel.app/api/push/schedule?cron=true" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub Actions")
          
          http_code=$(echo "$response" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_CODE:/d')
          
          echo "üìã Response:"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"
          echo ""
          echo "üìä HTTP Status Code: $http_code"
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "‚úÖ Notifications sent successfully"
            echo "success=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "‚ùå Failed to send notifications. HTTP Code: $http_code"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Report result
        if: always()
        run: |
          if [ "${{ steps.call-api.outputs.success }}" == "true" ]; then
            echo "‚úÖ Workflow completed successfully"
          else
            echo "‚ùå Workflow failed"
            exit 1
          fi

